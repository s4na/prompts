name: Claude Code Review - Auto PR Creation

on:
  workflow_run:
    workflows: ["Claude Code Review"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  create-fix-pr:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã® PR æƒ…å ±ã‚’å–å¾—
          PR_NUMBER=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/pull_requests --jq '.[] | select(.head.ref != null) | .number' | head -1)
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for this workflow run"
            exit 0
          fi

          # PR ãŒè‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ PR ã§ãªã„ã‹ã‚’ç¢ºèªï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
          LABELS=$(gh pr view $PR_NUMBER --json labels --jq '.labels[].name' 2>/dev/null | grep -c "claude-code-review" || echo "0")
          if [ "$LABELS" -gt 0 ]; then
            echo "This PR is already an auto-generated fix PR. Skipping."
            exit 0
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # PR ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
          gh pr view $PR_NUMBER --json number,title,body,baseRefName,headRefName > pr_info.json
          cat pr_info.json

      - name: Setup git config
        if: steps.pr-info.outputs.pr_number != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create fix branch
        if: steps.pr-info.outputs.pr_number != ''
        id: fix-branch
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          BASE_BRANCH=$(cat pr_info.json | jq -r '.baseRefName')
          FIX_BRANCH="fix/claude-review-${{ github.event.workflow_run.id }}"

          # ãƒ–ãƒ©ãƒ³ãƒã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
          if git rev-parse --verify origin/"$FIX_BRANCH" 2>/dev/null; then
            echo "Fix branch already exists. Skipping."
            exit 0
          fi

          git checkout -b "$FIX_BRANCH" "origin/$BASE_BRANCH" || {
            echo "Failed to create branch"
            exit 1
          }

          echo "fix_branch=$FIX_BRANCH" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Run Claude to analyze review and suggest fixes
        if: steps.pr-info.outputs.pr_number != '' && steps.fix-branch.outputs.fix_branch != ''
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW RUN ID: ${{ github.event.workflow_run.id }}
            PR NUMBER: ${{ steps.pr-info.outputs.pr_number }}

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ç¢ºèªã—ã¦ã€ä¿®æ­£ãŒå¿…è¦ãªã“ã¨ã¯ã™ã¹ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

            1. å‰å›ã® Claude Code Review ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèªï¼š
               $ gh pr comments ${{ steps.pr-info.outputs.pr_number }}

            2. æŒ‡æ‘˜ã•ã‚Œã¦ã„ã‚‹å•é¡Œã‚’ç¢ºèªã—ã€ã™ã¹ã¦ã®ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€ã‚’ç‰¹å®š

            3. ä¿®æ­£ãŒå¿…è¦ãªç®‡æ‰€ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„ï¼š
               - ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã¾ãŸã¯ä½œæˆ
               - git add ã§ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
               - git commit ã§å®Ÿè£…ã‚³ãƒŸãƒƒãƒˆ

            ä¿®æ­£ãŒå¿…è¦ã§ãªã„å ´åˆã¯ã€ä½•ã‚‚ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚

            ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ï¼š
            - `gh pr comments <number>` ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            - `git` ã§ä¿®æ­£ã‚’å®Ÿè£…ã—ã¦ã‚³ãƒŸãƒƒãƒˆ

          claude_args: '--allowed-tools "Bash(gh pr comments:*),Bash(git:*)"'

      - name: Check for changes
        if: steps.pr-info.outputs.pr_number != '' && steps.fix-branch.outputs.fix_branch != ''
        id: changes
        env:
          BASE_BRANCH: ${{ steps.fix-branch.outputs.base_branch }}
        run: |
          # ã‚³ãƒŸãƒƒãƒˆãŒå®Ÿè£…ã•ã‚ŒãŸã‹ã©ã†ã‹ã‚’ç¢ºèª
          if ! git diff --quiet "origin/$BASE_BRANCH"...HEAD; then
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "changes_made=false" >> $GITHUB_OUTPUT
          fi

      - name: Push fix branch and create PR
        if: steps.pr-info.outputs.pr_number != '' && steps.changes.outputs.changes_made == 'true'
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          FIX_BRANCH: ${{ steps.fix-branch.outputs.fix_branch }}
          BASE_BRANCH: ${{ steps.fix-branch.outputs.base_branch }}
        run: |
          set -e

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          if ! git push origin "$FIX_BRANCH" 2>&1; then
            echo "Failed to push branch"
            exit 1
          fi

          # PR ä½œæˆå‰ã« PR ãŒæ—¢ã«å­˜åœ¨ã—ãªã„ã‹ã‚’ç¢ºèª
          EXISTING_PR=$(gh pr list --head "$FIX_BRANCH" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for this branch"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR ã‚’ä½œæˆ
          NEW_PR=$(gh pr create \
            --base "$BASE_BRANCH" \
            --head "$FIX_BRANCH" \
            --title "ğŸ¤– Claude Code Review ä¿®æ­£: PR #$PR_NUMBER ã®æŒ‡æ‘˜äº‹é …ã‚’ä¿®æ­£" \
            --body "This PR fixes issues pointed out in the Claude Code Review of PR #$PR_NUMBER.

## ä¿®æ­£å†…å®¹
- Claude Code Review ã§æŒ‡æ‘˜ã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸ

## å‚ç…§
- ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ PR: #$PR_NUMBER
- ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ: ${{ github.event.workflow_run.html_url }}

---
ğŸ¤– This PR was automatically created based on Claude Code Review results." \
            --label "auto-generated,claude-code-review" \
            --json number --jq '.number')

          echo "pr_number=$NEW_PR" >> $GITHUB_OUTPUT

      - name: Add comment to original PR
        if: steps.pr-info.outputs.pr_number != '' && steps.changes.outputs.changes_made == 'true' && steps.create-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
          FIX_PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "âœ… Claude Code Review ã®æŒ‡æ‘˜äº‹é …ã«å¯¾ã™ã‚‹ä¿®æ­£ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

ä¿®æ­£å†…å®¹ã¯ #$FIX_PR_NUMBER ã§ææ¡ˆã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ã”ç¢ºèªãã ã•ã„ã€‚"

      - name: Skip message
        if: steps.pr-info.outputs.pr_number != '' && steps.changes.outputs.changes_made != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "â„¹ï¸ Claude Code Review ã®åˆ†æçµæœã€ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã«ã¯è¿½åŠ ã®ä¿®æ­£ãŒä¸è¦ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸã€‚

ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
