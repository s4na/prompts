name: Claude Code Review - Auto PR Creation

on:
  workflow_run:
    workflows: ["Claude Code Review"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  create-fix-pr:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR information
        id: pr-info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã® PR æƒ…å ±ã‚’å–å¾—
          PR_NUMBER=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/pull_requests --jq '.[] | select(.head.ref != null) | .number' | head -1)
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR found for this workflow run"
            exit 0
          fi
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # PR ã®è©³ç´°æƒ…å ±ã‚’å–å¾—
          gh pr view $PR_NUMBER --json number,title,body,baseRefName,headRefName > pr_info.json
          cat pr_info.json

      - name: Run Claude to analyze review and suggest fixes
        if: steps.pr-info.outputs.pr_number != ''
        id: claude-analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW RUN ID: ${{ github.event.workflow_run.id }}

            ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ç¢ºèªã—ã¦ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            1. å‰å›ã® Claude Code Review ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            2. æŒ‡æ‘˜ã•ã‚Œã¦ã„ã‚‹å•é¡Œã®æ¦‚è¦ã‚’ã¾ã¨ã‚ã‚‹
            3. ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã€ãã®å†…å®¹ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—

            ãã®å¾Œã€ä¿®æ­£ãŒå¿…è¦ã¨åˆ¤æ–­ã•ã‚ŒãŸå ´åˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            4. ä¿®æ­£å†…å®¹ã‚’å®Ÿè£…
            5. ä¿®æ­£å†…å®¹ã‚’ç¢ºèª
            6. ä¿®æ­£å†…å®¹ã‚’ã‚³ãƒŸãƒƒãƒˆ

            ä¿®æ­£ãŒä¸è¦ãªå ´åˆã¯ã€Œä¿®æ­£ä¸è¦ã€ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã—ã¦ãã ã•ã„ã€‚

            ä½¿ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ï¼š
            - `gh pr view <number>` ã§ PR è©³ç´°ã‚’ç¢ºèª
            - `gh pr comments <number>` ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            - `git` ã‚³ãƒãƒ³ãƒ‰ã§ä¿®æ­£ã‚’å®Ÿè£…

          claude_args: '--allowed-tools "Bash(gh pr view:*),Bash(gh pr comments:*),Bash(git:*),Bash(gh search:*)"'

      - name: Create fix branch and PR
        if: steps.pr-info.outputs.pr_number != '' && steps.claude-analysis.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          # ä¿®æ­£ç”¨ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          BASE_BRANCH=$(cat pr_info.json | jq -r '.baseRefName')
          FIX_BRANCH="fix/claude-review-${{ github.event.workflow_run.id }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$FIX_BRANCH"

          # ä¿®æ­£å†…å®¹ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
          # PR ã‚’ä½œæˆ
          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$FIX_BRANCH" \
            --title "ğŸ¤– Claude Code Review ä¿®æ­£: PR #$PR_NUMBER ã®æŒ‡æ‘˜äº‹é …ã‚’ä¿®æ­£" \
            --body "This PR fixes issues pointed out in the Claude Code Review of PR #$PR_NUMBER.

## ä¿®æ­£å†…å®¹
- Claude Code Review ã§æŒ‡æ‘˜ã•ã‚ŒãŸå•é¡Œã‚’ä¿®æ­£ã—ã¾ã—ãŸ

## å‚ç…§
- ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ PR: #$PR_NUMBER

---
ğŸ¤– This PR was automatically created based on Claude Code Review results."

      - name: Add comment to original PR
        if: steps.pr-info.outputs.pr_number != '' && steps.claude-analysis.outputs.changes_made == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        run: |
          gh pr comment $PR_NUMBER --body "âœ… Claude Code Review ã®æŒ‡æ‘˜äº‹é …ã«å¯¾ã™ã‚‹ä¿®æ­£ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

ä¿®æ­£å†…å®¹ã¯åˆ¥é€” PR ã§ææ¡ˆã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚ã”ç¢ºèªãã ã•ã„ã€‚"
